{
    "data_version": "4.0",
    "data_type": "CVE",
    "data_format": "MITRE",
    "CVE_data_meta": {
        "ID": "CVE-2024-57937",
        "ASSIGNER": "cve@kernel.org",
        "STATE": "PUBLIC"
    },
    "description": {
        "description_data": [
            {
                "lang": "eng",
                "value": "In the Linux kernel, the following vulnerability has been resolved:\n\nmm: reinstate ability to map write-sealed memfd mappings read-only\n\nPatch series \"mm: reinstate ability to map write-sealed memfd mappings\nread-only\".\n\nIn commit 158978945f31 (\"mm: perform the mapping_map_writable() check\nafter call_mmap()\") (and preceding changes in the same series) it became\npossible to mmap() F_SEAL_WRITE sealed memfd mappings read-only.\n\nCommit 5de195060b2e (\"mm: resolve faulty mmap_region() error path\nbehaviour\") unintentionally undid this logic by moving the\nmapping_map_writable() check before the shmem_mmap() hook is invoked,\nthereby regressing this change.\n\nThis series reworks how we both permit write-sealed mappings being mapped\nread-only and disallow mprotect() from undoing the write-seal, fixing this\nregression.\n\nWe also add a regression test to ensure that we do not accidentally\nregress this in future.\n\nThanks to Julian Orth for reporting this regression.\n\n\nThis patch (of 2):\n\nIn commit 158978945f31 (\"mm: perform the mapping_map_writable() check\nafter call_mmap()\") (and preceding changes in the same series) it became\npossible to mmap() F_SEAL_WRITE sealed memfd mappings read-only.\n\nThis was previously unnecessarily disallowed, despite the man page\ndocumentation indicating that it would be, thereby limiting the usefulness\nof F_SEAL_WRITE logic.\n\nWe fixed this by adapting logic that existed for the F_SEAL_FUTURE_WRITE\nseal (one which disallows future writes to the memfd) to also be used for\nF_SEAL_WRITE.\n\nFor background - the F_SEAL_FUTURE_WRITE seal clears VM_MAYWRITE for a\nread-only mapping to disallow mprotect() from overriding the seal - an\noperation performed by seal_check_write(), invoked from shmem_mmap(), the\nf_op->mmap() hook used by shmem mappings.\n\nBy extending this to F_SEAL_WRITE and critically - checking\nmapping_map_writable() to determine if we may map the memfd AFTER we\ninvoke shmem_mmap() - the desired logic becomes possible.  This is because\nmapping_map_writable() explicitly checks for VM_MAYWRITE, which we will\nhave cleared.\n\nCommit 5de195060b2e (\"mm: resolve faulty mmap_region() error path\nbehaviour\") unintentionally undid this logic by moving the\nmapping_map_writable() check before the shmem_mmap() hook is invoked,\nthereby regressing this change.\n\nWe reinstate this functionality by moving the check out of shmem_mmap()\nand instead performing it in do_mmap() at the point at which VMA flags are\nbeing determined, which seems in any case to be a more appropriate place\nin which to make this determination.\n\nIn order to achieve this we rework memfd seal logic to allow us access to\nthis information using existing logic and eliminate the clearing of\nVM_MAYWRITE from seal_check_write() which we are performing in do_mmap()\ninstead."
            }
        ]
    },
    "problemtype": {
        "problemtype_data": [
            {
                "description": [
                    {
                        "lang": "eng",
                        "value": "n/a"
                    }
                ]
            }
        ]
    },
    "affects": {
        "vendor": {
            "vendor_data": [
                {
                    "vendor_name": "Linux",
                    "product": {
                        "product_data": [
                            {
                                "product_name": "Linux",
                                "version": {
                                    "version_data": [
                                        {
                                            "version_affected": "<",
                                            "version_name": "5de195060b2e251a835f622759550e6202167641",
                                            "version_value": "464770df46095e6967334d77113972960f7ef1fa"
                                        },
                                        {
                                            "version_value": "not down converted",
                                            "x_cve_json_5_version_data": {
                                                "versions": [
                                                    {
                                                        "version": "6.12",
                                                        "status": "affected"
                                                    },
                                                    {
                                                        "version": "0",
                                                        "lessThan": "6.12",
                                                        "status": "unaffected",
                                                        "versionType": "semver"
                                                    },
                                                    {
                                                        "version": "6.12.9",
                                                        "lessThanOrEqual": "6.12.*",
                                                        "status": "unaffected",
                                                        "versionType": "semver"
                                                    },
                                                    {
                                                        "version": "6.13",
                                                        "lessThanOrEqual": "*",
                                                        "status": "unaffected",
                                                        "versionType": "original_commit_for_fix"
                                                    }
                                                ],
                                                "defaultStatus": "affected"
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    },
    "references": {
        "reference_data": [
            {
                "url": "https://git.kernel.org/stable/c/464770df46095e6967334d77113972960f7ef1fa",
                "refsource": "MISC",
                "name": "https://git.kernel.org/stable/c/464770df46095e6967334d77113972960f7ef1fa"
            },
            {
                "url": "https://git.kernel.org/stable/c/8ec396d05d1b737c87311fb7311f753b02c2a6b1",
                "refsource": "MISC",
                "name": "https://git.kernel.org/stable/c/8ec396d05d1b737c87311fb7311f753b02c2a6b1"
            }
        ]
    },
    "generator": {
        "engine": "bippy-5f407fcff5a0"
    }
}